{% extends "layout.html" %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <h2>השכרות</h2>
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addRentalModal">
                <i class="bi bi-plus-lg"></i> הוסף השכרה
            </button>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>מספר השכרה</th>
                                <th>שם לקוח</th>
                                <th>מספר רכב</th>
                                <th>תאריך התחלה</th>
                                <th>תאריך סיום</th>
                                <th>סטטוס</th>
                                <th>פעולות</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for rental in rentals %}
                            <tr>
                                <td>{{ rental[0] }}</td>
                                <td>{{ rental[1] }}</td>
                                <td>{{ rental[2] }}</td>
                                <td>{{ rental[3] }}</td>
                                <td>{{ rental[4] }}</td>
                                <td>
                                    <span class="badge {% if rental[4] >= today %}bg-success{% else %}bg-secondary{% endif %}">
                                        {{ 'פעיל' if rental[4] >= today else 'הסתיים' }}
                                    </span>
                                </td>
                                <td>
                                    {% if rental[4] >= today %}
                                    <form action="{{ url_for('end_rental') }}" method="POST" style="display: inline;">
                                        <input type="hidden" name="rental_id" value="{{ rental[0] }}">
                                        <button type="submit" class="btn btn-sm btn-warning" onclick="return confirm('האם אתה בטוח שברצונך לסיים השכרה זו?')">
                                            <i class="bi bi-clock-history"></i> סיים השכרה
                                        </button>
                                    </form>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Rental Modal -->
<div class="modal fade" id="addRentalModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">הוסף השכרה חדשה</h5>
            </div>
            <form id="rentalForm" action="{{ url_for('add_rental') }}" method="POST">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">מספר ת.ז לקוח</label>
                        <input type="text" class="form-control" name="customer_id" id="customer_id" required pattern="[0-9]{9}" title="נא להזין 9 ספרות">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">שם לקוח</label>
                        <input type="text" class="form-control" id="customer_name" readonly>
                        <div id="customerNotFound" class="text-danger mt-1" style="display: none;">
                            לקוח לא נמצא במערכת
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">בחר רכב</label>
                        <select class="form-select" name="vehicle_id" id="vehicle_id" required>
                            <option value="">-- בחר רכב --</option>
                        </select>
                        <div id="loadingVehicles" class="text-muted mt-2" style="display: none;">
                            <i class="bi bi-arrow-repeat"></i> טוען רכבים זמינים...
                        </div>
                    </div>

                    <div id="vehicleDetails" class="alert alert-info" style="display: none;">
                        <h6 class="alert-heading mb-2">פרטי הרכב הנבחר:</h6>
                        <p id="vehicleInfo" class="mb-0"></p>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">תאריך התחלה</label>
                                <input type="date" class="form-control" name="start_date" id="start_date" required>
                                <div id="startDateWarning" class="text-danger mt-1" style="display: none;"></div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">תאריך סיום</label>
                                <input type="date" class="form-control" name="end_date" id="end_date" required>
                                <div id="endDateWarning" class="text-danger mt-1" style="display: none;"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ביטול</button>
                    <button type="submit" class="btn btn-primary">הוסף השכרה</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% block scripts %}
<script>
// הגדרת תאריך מינימלי להיום
const today = new Date().toISOString().split('T')[0];
document.getElementById('start_date').min = today;
document.getElementById('end_date').min = today;

// טעינת רשימת הרכבים הזמינים
async function loadAvailableVehicles() {
    const loadingElement = document.getElementById('loadingVehicles');
    const select = document.getElementById('vehicle_id');
    
    try {
        loadingElement.style.display = 'block';
        const response = await fetch('/api/vehicles/available');
        const data = await response.json();
        
        // מחיקת כל האופציות הקיימות
        select.innerHTML = '<option value="">-- בחר רכב --</option>';
        
        // הוספת כל הרכבים הזמינים לרשימה הנפתחת
        data.forEach(model => {
            const optgroup = document.createElement('optgroup');
            optgroup.label = model.model_name;
            
            model.vehicles.forEach(vehicle => {
                const option = document.createElement('option');
                option.value = vehicle.license_plate;
                // הצגת שנה רק אם היא קיימת
                const yearText = vehicle.year ? ` (${vehicle.year})` : '';
                option.textContent = `${vehicle.license_plate} - ${vehicle.brand} ${vehicle.model}${yearText}`;
                option.dataset.details = JSON.stringify(vehicle);
                optgroup.appendChild(option);
            });
            
            select.appendChild(optgroup);
        });
    } catch (error) {
        console.error('שגיאה בטעינת רשימת הרכבים:', error);
        select.innerHTML = '<option value="">שגיאה בטעינת רכבים</option>';
    } finally {
        loadingElement.style.display = 'none';
    }
}

// בדיקת תאריכים
function validateDates() {
    const startDate = document.getElementById('start_date').value;
    const endDate = document.getElementById('end_date').value;
    const startWarning = document.getElementById('startDateWarning');
    const endWarning = document.getElementById('endDateWarning');
    
    if (startDate && endDate) {
        if (startDate > endDate) {
            endWarning.textContent = 'תאריך הסיום חייב להיות אחרי תאריך ההתחלה';
            endWarning.style.display = 'block';
            return false;
        }
        if (startDate < today) {
            startWarning.textContent = 'לא ניתן לבחור תאריך בעבר';
            startWarning.style.display = 'block';
            return false;
        }
    }
    
    startWarning.style.display = 'none';
    endWarning.style.display = 'none';
    return true;
}

// הצגת פרטי הרכב
document.getElementById('vehicle_id').addEventListener('change', function() {
    const vehicleDetails = document.getElementById('vehicleDetails');
    const vehicleInfo = document.getElementById('vehicleInfo');
    
    if (this.value) {
        const selectedOption = this.options[this.selectedIndex];
        const vehicle = JSON.parse(selectedOption.dataset.details);
        
        // בניית HTML לפרטי הרכב, כולל שנה רק אם היא קיימת
        let detailsHtml = `
            <strong>מספר רישוי:</strong> ${vehicle.license_plate}<br>
            <strong>יצרן:</strong> ${vehicle.brand}<br>
            <strong>דגם:</strong> ${vehicle.model}
        `;
        
        if (vehicle.year) {
            detailsHtml += `<br><strong>שנה:</strong> ${vehicle.year}`;
        }
        
        vehicleInfo.innerHTML = detailsHtml;
        vehicleDetails.style.display = 'block';
    } else {
        vehicleDetails.style.display = 'none';
    }
});

// אירועי תאריכים
document.getElementById('start_date').addEventListener('change', validateDates);
document.getElementById('end_date').addEventListener('change', validateDates);

// טעינת רכבים בפתיחת המודל
document.getElementById('addRentalModal').addEventListener('show.bs.modal', function () {
    loadAvailableVehicles();
});

// הגשת הטופס
document.getElementById('rentalForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    if (!validateDates()) {
        return;
    }
    
    try {
        const response = await fetch(this.action, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: new URLSearchParams(new FormData(this))
        });
        
        if (response.ok) {
            // סגירת המודל
            const modal = bootstrap.Modal.getInstance(document.getElementById('addRentalModal'));
            modal.hide();
            
            // רענון הדף
            window.location.reload();
        } else {
            const data = await response.json();
            alert(data.error || 'שגיאה בהוספת ההשכרה');
        }
    } catch (error) {
        console.error('שגיאה:', error);
        alert('שגיאה בשליחת הטופס');
    }
});

// הוספת אירוע לטעינת פרטי לקוח
document.getElementById('customer_id').addEventListener('input', async function() {
    const customerNameField = document.getElementById('customer_name');
    const customerNotFound = document.getElementById('customerNotFound');
    
    // אם הוזנו 9 ספרות
    if (this.value.length === 9) {
        try {
            const response = await fetch(`/api/customer/${this.value}`);
            const data = await response.json();
            
            if (response.ok) {
                customerNameField.value = data.name;
                customerNotFound.style.display = 'none';
            } else {
                customerNameField.value = '';
                customerNotFound.style.display = 'block';
            }
        } catch (error) {
            console.error('שגיאה בטעינת פרטי לקוח:', error);
            customerNameField.value = '';
            customerNotFound.style.display = 'block';
        }
    } else {
        customerNameField.value = '';
        customerNotFound.style.display = 'none';
    }
});
</script>
{% endblock %}

{% endblock %} 